{% extends 'admin/admin_base.html' %}

{% block title %}Create Event - WildQuest Kenya Admin{% endblock %}

{% block page_title %}Create New Event{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Admin</a></li>
        <li class="breadcrumb-item"><a href="{% url 'admin_events_list' %}">Events</a></li>
        <li class="breadcrumb-item active" aria-current="page">Create Event</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">Create New Event</h2>
        <p class="text-muted mb-0">Add a new adventure or experience to WildQuest Kenya</p>
    </div>
    <a href="{% url 'admin_events_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Events
    </a>
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div class="row g-4">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Event Images -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-image me-2"></i>
                        Event Images
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">Primary Image <span class="text-danger">*</span></label>
                            {{ form.primary_image }}
                            <div class="form-text">Main event image (recommended size: 1200x800px)</div>
                            {% if form.primary_image.errors %}
                                <div class="invalid-feedback d-block">{{ form.primary_image.errors.0 }}</div>
                            {% endif %}
                            <div id="primaryImagePreview" class="mt-3"></div>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold">Additional Images</label>
                            {{ form.additional_images }}
                            <div class="form-text">Upload multiple images for the gallery (optional)</div>
                            {% if form.additional_images.errors %}
                                <div class="invalid-feedback d-block">{{ form.additional_images.errors.0 }}</div>
                            {% endif %}
                            <div id="additionalImagesPreview" class="mt-3 row g-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Basic Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-info-circle me-2"></i>
                        Basic Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">Event Title <span class="text-danger">*</span></label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold">URL Slug</label>
                            {{ form.slug }}
                            <div class="form-text">{{ form.slug.help_text }}</div>
                            {% if form.slug.errors %}
                                <div class="invalid-feedback d-block">{{ form.slug.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold">Short Description <span class="text-danger">*</span></label>
                            {{ form.short_description }}
                            <div class="form-text">Brief description for listings (max 300 characters)</div>
                            {% if form.short_description.errors %}
                                <div class="invalid-feedback d-block">{{ form.short_description.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold">Full Description <span class="text-danger">*</span></label>
                            {{ form.description }}
                            <div class="form-text">Detailed description of the event</div>
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Category <span class="text-danger">*</span></label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="invalid-feedback d-block">{{ form.category.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Event Type <span class="text-danger">*</span></label>
                            {{ form.event_type }}
                            {% if form.event_type.errors %}
                                <div class="invalid-feedback d-block">{{ form.event_type.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold">Location <span class="text-danger">*</span></label>
                            {{ form.location }}
                            {% if form.location.errors %}
                                <div class="invalid-feedback d-block">{{ form.location.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date & Duration -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-calendar me-2"></i>
                        Schedule & Duration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Start Date & Time <span class="text-danger">*</span></label>
                            {{ form.start_date }}
                            {% if form.start_date.errors %}
                                <div class="invalid-feedback d-block">{{ form.start_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">End Date & Time <span class="text-danger">*</span></label>
                            {{ form.end_date }}
                            {% if form.end_date.errors %}
                                <div class="invalid-feedback d-block">{{ form.end_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Duration (Days) <span class="text-danger">*</span></label>
                            {{ form.duration_days }}
                            {% if form.duration_days.errors %}
                                <div class="invalid-feedback d-block">{{ form.duration_days.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Booking Deadline <span class="text-danger">*</span></label>
                            {{ form.booking_deadline }}
                            <div class="form-text">Last date customers can book this event</div>
                            {% if form.booking_deadline.errors %}
                                <div class="invalid-feedback d-block">{{ form.booking_deadline.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Capacity & Pricing -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-people me-2"></i>
                        Capacity & Pricing
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Maximum Participants <span class="text-danger">*</span></label>
                            {{ form.max_participants }}
                            {% if form.max_participants.errors %}
                                <div class="invalid-feedback d-block">{{ form.max_participants.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Minimum Participants <span class="text-danger">*</span></label>
                            {{ form.min_participants }}
                            <div class="form-text">Minimum required to run the event</div>
                            {% if form.min_participants.errors %}
                                <div class="invalid-feedback d-block">{{ form.min_participants.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Base Price (KSh) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">KSh</span>
                                {{ form.base_price }}
                            </div>
                            {% if form.base_price.errors %}
                                <div class="invalid-feedback d-block">{{ form.base_price.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Child Price (KSh)</label>
                            <div class="input-group">
                                <span class="input-group-text">KSh</span>
                                {{ form.child_price }}
                            </div>
                            <div class="form-text">Leave empty if same as base price</div>
                            {% if form.child_price.errors %}
                                <div class="invalid-feedback d-block">{{ form.child_price.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">VIP Price (KSh)</label>
                            <div class="input-group">
                                <span class="input-group-text">KSh</span>
                                {{ form.vip_price }}
                            </div>
                            {% if form.vip_price.errors %}
                                <div class="invalid-feedback d-block">{{ form.vip_price.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Group Discount (%)</label>
                            <div class="input-group">
                                {{ form.group_discount_percentage }}
                                <span class="input-group-text">%</span>
                            </div>
                            {% if form.group_discount_percentage.errors %}
                                <div class="invalid-feedback d-block">{{ form.group_discount_percentage.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Details -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-list-ul me-2"></i>
                        Event Details
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">What's Included</label>
                            {{ form.includes }}
                            <div class="form-text">List what's included in the package price</div>
                            {% if form.includes.errors %}
                                <div class="invalid-feedback d-block">{{ form.includes.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold">What's Excluded</label>
                            {{ form.excludes }}
                            <div class="form-text">List what's not included in the package price</div>
                            {% if form.excludes.errors %}
                                <div class="invalid-feedback d-block">{{ form.excludes.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold">Requirements</label>
                            {{ form.requirements }}
                            <div class="form-text">Any requirements for participants (age, fitness level, etc.)</div>
                            {% if form.requirements.errors %}
                                <div class="invalid-feedback d-block">{{ form.requirements.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label fw-semibold">Cancellation Policy</label>
                            {{ form.cancellation_policy }}
                            {% if form.cancellation_policy.errors %}
                                <div class="invalid-feedback d-block">{{ form.cancellation_policy.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Event Settings -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 text-dark">
                        <i class="bi bi-gear me-2"></i>
                        Event Settings
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">Status</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">{{ form.status.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check">
                                {{ form.featured }}
                                <label class="form-check-label" for="{{ form.featured.id_for_label }}">
                                    Featured Event
                                </label>
                                <div class="form-text">Mark as featured to highlight on homepage</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Options -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 text-dark">
                        <i class="bi bi-credit-card me-2"></i>
                        Booking Options
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-check">
                                {{ form.whatsapp_booking }}
                                <label class="form-check-label" for="{{ form.whatsapp_booking.id_for_label }}">
                                    Allow WhatsApp Booking
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check">
                                {{ form.online_payment }}
                                <label class="form-check-label" for="{{ form.online_payment.id_for_label }}">
                                    Enable Online Payment
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help & Tips -->
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-header bg-transparent border-0 py-3">
                    <h6 class="mb-0 text-dark">
                        <i class="bi bi-lightbulb me-2"></i>
                        Tips for Success
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0 small">
                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Use high-quality images (min 1200px wide)</li>
                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Upload at least 3-5 images for gallery</li>
                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Use descriptive titles that include location</li>
                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Set realistic capacity based on logistics</li>
                        <li class="mb-0"><i class="bi bi-check text-success me-2"></i>Include clear cancellation policies</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-4">
                    <button type="submit" class="btn btn-primary btn-lg me-3">
                        <i class="bi bi-plus-circle me-2"></i>Create Event
                    </button>
                    <a href="{% url 'admin_events_list' %}" class="btn btn-outline-secondary btn-lg">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image Preview for Primary Image
    const primaryImageInput = document.getElementById('id_primary_image');
    if (primaryImageInput) {
        primaryImageInput.addEventListener('change', function(e) {
            const preview = document.getElementById('primaryImagePreview');
            preview.innerHTML = '';
            
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    preview.innerHTML = `
                        <div class="position-relative d-inline-block">
                            <img src="${event.target.result}" class="img-thumbnail" style="max-height: 200px;">
                            <span class="badge bg-primary position-absolute top-0 start-0 m-2">Primary</span>
                        </div>
                    `;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
    }
    
    // Image Preview for Additional Images
    const additionalImagesInput = document.getElementById('id_additional_images');
    if (additionalImagesInput) {
        additionalImagesInput.addEventListener('change', function(e) {
            const preview = document.getElementById('additionalImagesPreview');
            preview.innerHTML = '';
            
            if (e.target.files) {
                Array.from(e.target.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const col = document.createElement('div');
                        col.className = 'col-4';
                        col.innerHTML = `
                            <div class="position-relative">
                                <img src="${event.target.result}" class="img-thumbnail w-100" style="height: 150px; object-fit: cover;">
                                <span class="badge bg-secondary position-absolute top-0 start-0 m-2">${index + 1}</span>
                            </div>
                        `;
                        preview.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });
    }
    
    // Auto-generate slug from title
    const titleField = document.getElementById('id_title');
    const slugField = document.getElementById('id_slug');
    if (titleField && slugField) {
        titleField.addEventListener('input', function() {
            if (!slugField.value || slugField.dataset.autoGenerated === 'true') {
                const slug = this.value
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
                slugField.value = slug;
                slugField.dataset.autoGenerated = 'true';
            }
        });
        
        slugField.addEventListener('input', function() {
            if (this.value) {
                this.dataset.autoGenerated = 'false';
            }
        });
    }
    
    // Date validation
    const startDateField = document.getElementById('id_start_date');
    const endDateField = document.getElementById('id_end_date');
    const bookingDeadlineField = document.getElementById('id_booking_deadline');
    
    function validateDates() {
        const startDate = new Date(startDateField.value);
        const endDate = new Date(endDateField.value);
        const deadline = new Date(bookingDeadlineField.value);
        
        if (startDate && endDate && endDate <= startDate) {
            endDateField.setCustomValidity('End date must be after start date');
        } else {
            endDateField.setCustomValidity('');
        }
        
        if (deadline && startDate && deadline >= startDate) {
            bookingDeadlineField.setCustomValidity('Booking deadline must be before start date');
        } else {
            bookingDeadlineField.setCustomValidity('');
        }
    }
    
    if (startDateField && endDateField) {
        startDateField.addEventListener('change', validateDates);
        endDateField.addEventListener('change', validateDates);
        bookingDeadlineField.addEventListener('change', validateDates);
    }
});
</script>

<style>
.form-control, .form-select {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.75rem;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(13, 107, 104, 0.25);
}

.btn-primary {
    background-color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
}

.btn-primary:hover {
    background-color: var(--primary-dark) !important;
    border-color: var(--primary-dark) !important;
}
</style>
{% endblock %}