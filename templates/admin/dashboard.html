{% extends 'admin/admin_base.html' %}
{% load math_filters %}
{% load static %}
{% block title %}Dashboard - WildQuest Kenya Admin{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        border: none;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--bs-primary);
    }

    .stats-card.success::before { background: var(--bs-success); }
    .stats-card.warning::before { background: var(--bs-warning); }
    .stats-card.danger::before { background: var(--bs-danger); }
    .stats-card.info::before { background: var(--bs-info); }

    .stats-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    .stats-number {
        font-size: 2.2rem;
        font-weight: 700;
        color: #1e2832;
        margin: 0;
    }

    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stats-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: white;
        margin-left: auto;
    }

    .chart-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 25px;
    }

    .chart-header {
        background: linear-gradient(135deg, #1e2832 0%, #34495e 100%);
        color: white;
        padding: 20px;
        border: none;
    }

    .chart-header h5 {
        margin: 0;
        font-weight: 600;
    }

    .chart-body {
        padding: 25px;
    }

    .activity-item {
        padding: 15px 0;
        border-bottom: 1px solid #f1f3f4;
        transition: all 0.2s ease;
    }

    .activity-item:hover {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin: 0 -15px;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .badge-status {
        font-size: 0.75rem;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
    }

    .metric-change {
        font-size: 0.8rem;
        font-weight: 600;
    }

    .metric-change.positive {
        color: #198754;
    }

    .metric-change.negative {
        color: #dc3545;
    }

    .table-dashboard {
        margin: 0;
    }

    .table-dashboard th {
        background: #f8f9fa;
        border: none;
        font-weight: 600;
        color: #1e2832;
        padding: 15px;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table-dashboard td {
        border: none;
        padding: 15px;
        vertical-align: middle;
    }

    .alert-custom {
        border: none;
        border-radius: 10px;
        padding: 15px 20px;
    }

    .progress-custom {
        height: 8px;
        border-radius: 10px;
        background: #e9ecef;
    }

    .quick-stats {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 20px;
    }

    @media (max-width: 768px) {
        .stats-number {
            font-size: 1.8rem;
        }
        
        .chart-body {
            padding: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Key Metrics Row -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">Total Events</p>
                    <h3 class="stats-number">{{ total_events }}</h3>
                    <small class="text-success">{{ active_events }} active</small>
                </div>
                <div class="stats-icon" style="background: linear-gradient(135deg, #007bff, #0056b3);">
                    <i class="bi bi-calendar-event"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stats-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">Total Bookings</p>
                    <h3 class="stats-number">{{ total_bookings }}</h3>
                    <small class="text-warning">{{ pending_bookings }} pending</small>
                </div>
                <div class="stats-icon" style="background: linear-gradient(135deg, #28a745, #1e7e34);">
                    <i class="bi bi-ticket-perforated"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stats-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">Total Revenue</p>
                    <h3 class="stats-number">KSh {{ total_revenue|floatformat:0 }}</h3>
                    <small class="text-success">KSh {{ revenue_30_days|floatformat:0 }} (30 days)</small>
                </div>
                <div class="stats-icon" style="background: linear-gradient(135deg, #17a2b8, #117a8b);">
                    <i class="bi bi-cash-stack"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stats-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">Avg Booking</p>
                    <h3 class="stats-number">KSh {{ avg_booking_value|floatformat:0 }}</h3>
                    <small class="text-info">{{ total_customers }} customers</small>
                </div>
                <div class="stats-icon" style="background: linear-gradient(135deg, #ffc107, #d39e00);">
                    <i class="bi bi-graph-up"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Revenue Trend Chart -->
    <div class="col-xl-8">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-graph-up me-2"></i>Revenue & Bookings Trend (Last 12 Months)</h5>
            </div>
            <div class="chart-body">
                <canvas id="revenueChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Booking Status Donut Chart -->
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-pie-chart me-2"></i>Booking Status Distribution</h5>
            </div>
            <div class="chart-body">
                <canvas id="statusChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Second Charts Row -->
<div class="row g-4 mb-4">
    <!-- Category Performance Bar Chart -->
    <div class="col-xl-7">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-bar-chart me-2"></i>Category Performance</h5>
            </div>
            <div class="chart-body">
                <canvas id="categoryChart" height="120"></canvas>
            </div>
        </div>
    </div>

    <!-- Daily Bookings Area Chart -->
    <div class="col-xl-5">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-activity me-2"></i>Daily Bookings (Last 30 Days)</h5>
            </div>
            <div class="chart-body">
                <canvas id="dailyChart" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables Row -->
<div class="row g-4 mb-4">
    <!-- Top Events -->
    <div class="col-xl-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-star me-2"></i>Top Performing Events</h5>
            </div>
            <div class="chart-body p-0">
                <div class="table-responsive">
                    <table class="table table-dashboard mb-0">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Bookings</th>
                                <th>Revenue</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in top_events %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ event.title|truncatechars:30 }}</strong>
                                        <br><small class="text-muted">{{ event.location.name }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ event.booking_count }}</span>
                                </td>
                                <td>
                                    <strong>KSh {{ event.total_revenue|floatformat:0|default:"0" }}</strong>
                                </td>
                                <td>
                                    <span class="badge badge-status bg-{% if event.status == 'published' %}success{% else %}warning{% endif %}">
                                        {{ event.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    No events with bookings yet
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-xl-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-clock-history me-2"></i>Recent Bookings</h5>
            </div>
            <div class="chart-body">
                {% for booking in recent_bookings %}
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong>{{ booking.customer_name }}</strong>
                            <div class="text-muted small">{{ booking.event.title|truncatechars:35 }}</div>
                            <small class="text-muted">{{ booking.booked_at|timesince }} ago</small>
                        </div>
                        <div class="text-end">
                            <span class="badge badge-status bg-{% if booking.status == 'confirmed' %}success{% elif booking.status == 'pending' %}warning{% elif booking.status == 'paid' %}primary{% else %}secondary{% endif %}">
                                {{ booking.get_status_display }}
                            </span>
                            <div class="small text-muted mt-1">KSh {{ booking.total_amount|floatformat:0 }}</div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox display-4"></i>
                    <p class="mb-0">No recent bookings</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats and Alerts -->
<div class="row g-4 mb-4">
    <!-- System Alerts -->
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>System Alerts</h5>
            </div>
            <div class="chart-body">
                {% if pending_whatsapp > 0 %}
                <div class="alert alert-warning alert-custom d-flex align-items-center">
                    <i class="bi bi-whatsapp me-3 fs-4"></i>
                    <div>
                        <strong>{{ pending_whatsapp }}</strong> WhatsApp booking requests pending
                    </div>
                </div>
                {% endif %}

                {% if unresolved_inquiries > 0 %}
                <div class="alert alert-info alert-custom d-flex align-items-center">
                    <i class="bi bi-envelope me-3 fs-4"></i>
                    <div>
                        <strong>{{ unresolved_inquiries }}</strong> unresolved customer inquiries
                    </div>
                </div>
                {% endif %}

                {% if expiring_events > 0 %}
                <div class="alert alert-danger alert-custom d-flex align-items-center">
                    <i class="bi bi-calendar-x me-3 fs-4"></i>
                    <div>
                        <strong>{{ expiring_events }}</strong> events with booking deadlines expiring soon
                    </div>
                </div>
                {% endif %}

                {% if pending_whatsapp == 0 and unresolved_inquiries == 0 and expiring_events == 0 %}
                <div class="alert alert-success alert-custom d-flex align-items-center">
                    <i class="bi bi-check-circle me-3 fs-4"></i>
                    <div>
                        All systems are running smoothly!
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Payment Methods -->
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-credit-card me-2"></i>Payment Methods</h5>
            </div>
            <div class="chart-body">
                <canvas id="paymentMethodsChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-speedometer me-2"></i>Quick Stats</h5>
            </div>
            <div class="chart-body">
                <div class="quick-stats">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="mb-0 text-primary">{{ repeat_customers }}</h4>
                                <small class="text-muted">Repeat Customers</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="mb-0 text-warning">{{ avg_rating }}</h4>
                                <small class="text-muted">Avg Rating</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="mb-0 text-success">{{ total_reviews }}</h4>
                                <small class="text-muted">Total Reviews</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="mb-0 text-info">{{ revenue_7_days|floatformat:0 }}</h4>
                                <small class="text-muted">7-Day Revenue</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Popular Locations Table -->
<div class="row g-4">
    <div class="col-12">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-geo-alt me-2"></i>Popular Destinations</h5>
            </div>
            <div class="chart-body p-0">
                <div class="table-responsive">
                    <table class="table table-dashboard mb-0">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>County</th>
                                <th>Events</th>
                                <th>Bookings</th>
                                <th>Popularity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for location in popular_locations %}
                            <tr>
                                <td>
                                    <strong>{{ location.name }}</strong>
                                    <br><small class="text-muted">{{ location.region }}</small>
                                </td>
                                <td>{{ location.county }}</td>
                                <td>
                                    <span class="badge bg-info">{{ location.event_count }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ location.booking_count }}</span>
                                </td>
                                <td>
                                    <div class="progress progress-custom">
                                        <div class="progress-bar bg-primary" style="width: {{ location.booking_count|progress_width:10 }}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    No location data available
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Chart.js Configuration
Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.color = '#6c757d';

// Revenue and Bookings Trend Chart
const revenueCtx = document.getElementById('revenueChart').getContext('2d');
const monthlyData = {{ monthly_revenue_data|safe }};

new Chart(revenueCtx, {
    type: 'line',
    data: {
        labels: monthlyData.map(item => item.month),
        datasets: [{
            label: 'Revenue (KSh)',
            data: monthlyData.map(item => item.revenue),
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y'
        }, {
            label: 'Bookings',
            data: monthlyData.map(item => item.bookings),
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Month'
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Revenue (KSh)'
                },
                ticks: {
                    callback: function(value) {
                        return 'KSh ' + value.toLocaleString();
                    }
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Bookings'
                },
                grid: {
                    drawOnChartArea: false,
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        }
    }
});

// Booking Status Donut Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusData = {{ booking_status_data|safe }};

new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: statusData.map(item => item.status),
        datasets: [{
            data: statusData.map(item => item.count),
            backgroundColor: [
                '#007bff',
                '#28a745', 
                '#ffc107',
                '#dc3545',
                '#6c757d',
                '#17a2b8'
            ],
            borderWidth: 0,
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = Math.round((context.raw / total) * 100);
                        return context.label + ': ' + context.raw + ' (' + percentage + '%)';
                    }
                }
            }
        }
    }
});

// Category Performance Bar Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryData = {{ category_performance_data|safe }};

new Chart(categoryCtx, {
    type: 'bar',
    data: {
        labels: categoryData.map(item => item.name),
        datasets: [{
            label: 'Bookings',
            data: categoryData.map(item => item.bookings),
            backgroundColor: 'rgba(0, 123, 255, 0.8)',
            borderColor: '#007bff',
            borderWidth: 1
        }, {
            label: 'Revenue (KSh)',
            data: categoryData.map(item => item.revenue),
            backgroundColor: 'rgba(40, 167, 69, 0.8)',
            borderColor: '#28a745',
            borderWidth: 1,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Categories'
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Bookings'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Revenue (KSh)'
                },
                grid: {
                    drawOnChartArea: false,
                },
                ticks: {
                    callback: function(value) {
                        return 'KSh ' + value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        }
    }
});

// Daily Bookings Area Chart
const dailyCtx = document.getElementById('dailyChart').getContext('2d');
const dailyData = {{ daily_bookings_data|safe }};

new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: dailyData.map(item => item.day),
        datasets: [{
            label: 'Daily Bookings',
            data: dailyData.map(item => item.bookings),
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.2)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#17a2b8',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                },
                title: {
                    display: true,
                    text: 'Bookings'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Day of Month'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Payment Methods Donut Chart
const paymentCtx = document.getElementById('paymentMethodsChart').getContext('2d');
const paymentData = {{ payment_methods_data|safe }};

if (paymentData.length > 0) {
    new Chart(paymentCtx, {
        type: 'doughnut',
        data: {
            labels: paymentData.map(item => item.method),
            datasets: [{
                data: paymentData.map(item => item.count),
                backgroundColor: [
                    '#28a745',
                    '#007bff', 
                    '#ffc107',
                    '#dc3545',
                    '#6c757d',
                    '#17a2b8'
                ],
                borderWidth: 0,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((context.raw / total) * 100);
                            return context.label + ': ' + context.raw + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
} else {
    // Show message if no payment data
    paymentCtx.canvas.style.display = 'none';
    paymentCtx.canvas.parentNode.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-credit-card display-6"></i><p class="mb-0 mt-2">No payment data available</p></div>';
}

// Auto-refresh data every 5 minutes
setInterval(function() {
    location.reload();
}, 300000); // 5 minutes

// Animate numbers on page load
function animateNumbers() {
    const numbers = document.querySelectorAll('.stats-number');
    numbers.forEach(number => {
        const finalValue = parseInt(number.textContent.replace(/[^\d]/g, ''));
        if (finalValue > 0) {
            let currentValue = 0;
            const increment = finalValue / 100;
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= finalValue) {
                    currentValue = finalValue;
                    clearInterval(timer);
                }
                if (number.textContent.includes('KSh')) {
                    number.textContent = 'KSh ' + Math.floor(currentValue).toLocaleString();
                } else {
                    number.textContent = Math.floor(currentValue);
                }
            }, 20);
        }
    });
}

// Initialize animations when page loads
document.addEventListener('DOMContentLoaded', function() {
    animateNumbers();
});
</script>
{% endblock %}