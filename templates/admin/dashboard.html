{% extends 'admin/admin_base.html' %}
{% load math_filters %}
{% load static %}
{% block title %}Dashboard - WildQuest Kenya Admin{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #0d6b68;
        --primary-dark: #0a5652;
        --primary-light: #e8f3f2;
        --success-color: #198754;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --gray-light: #f8f9fa;
        --gray-medium: #e9ecef;
        --gray-dark: #6c757d;
    }

    .stats-card {
        background: white;
        border-radius: 6px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #f1f3f4;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--primary-color);
    }

    .stats-card.success::before { background: var(--success-color); }
    .stats-card.warning::before { background: var(--warning-color); }
    .stats-card.danger::before { background: var(--danger-color); }
    .stats-card.info::before { background: var(--info-color); }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: var(--primary-light);
    }

    .stats-number {
        font-size: 2.2rem;
        font-weight: 700;
        color: #1e2832;
        margin: 0;
        line-height: 1.2;
    }

    .stats-label {
        color: var(--gray-dark);
        font-size: 0.9rem;
        font-weight: 500;
        margin: 0 0 8px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        margin-left: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .stats-icon.primary { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); }
    .stats-icon.success { background: linear-gradient(135deg, var(--success-color), #157347); }
    .stats-icon.info { background: linear-gradient(135deg, var(--info-color), #117a8b); }
    .stats-icon.warning { background: linear-gradient(135deg, var(--warning-color), #d39e00); }

    .chart-container {
        background: white;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #f1f3f4;
        overflow: hidden;
        margin-bottom: 25px;
        transition: all 0.3s ease;
        
        /* Added height */
        height: 500px; /* adjust as needed */
        /* Or use min-height for flexibility */
        /* min-height: 400px; */
    }

    .chart-container canvas,
    .chart-container svg {
        height: 100% !important;
        width: 100% !important;
    }



    .chart-container:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .chart-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        padding: 20px 25px;
        border: none;
    }

    .chart-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .chart-body {
        padding: 25px;
    }

    .activity-item {
        padding: 15px 0;
        border-bottom: 1px solid var(--gray-medium);
        transition: all 0.2s ease;
    }

    .activity-item:hover {
        background: var(--primary-light);
        border-radius: 8px;
        padding: 15px;
        margin: 0 -15px;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .badge-status {
        font-size: 0.75rem;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
    }

    .metric-change {
        font-size: 0.8rem;
        font-weight: 600;
    }

    .metric-change.positive {
        color: var(--success-color);
    }

    .metric-change.negative {
        color: var(--danger-color);
    }

    .table-dashboard {
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
    }

    .table-dashboard th {
        background: var(--gray-light);
        border: none;
        font-weight: 600;
        color: var(--primary-dark);
        padding: 15px;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--primary-color);
    }

    .table-dashboard td {
        border: none;
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid var(--gray-medium);
    }

    .table-dashboard tr:last-child td {
        border-bottom: none;
    }

    .table-dashboard tr:hover td {
        background-color: var(--primary-light);
    }

    .alert-custom {
        border: none;
        border-radius: 10px;
        padding: 15px 20px;
        border-left: 4px solid;
    }

    .alert-warning.alert-custom {
        border-left-color: var(--warning-color);
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    }

    .alert-info.alert-custom {
        border-left-color: var(--info-color);
        background: linear-gradient(135deg, #d1ecf1, #b8e6f1);
    }

    .alert-danger.alert-custom {
        border-left-color: var(--danger-color);
        background: linear-gradient(135deg, #f8d7da, #f5c2c7);
    }

    .alert-success.alert-custom {
        border-left-color: var(--success-color);
        background: linear-gradient(135deg, #d1e7dd, #b8e6d1);
    }

    .progress-custom {
        height: 8px;
        border-radius: 10px;
        background: var(--gray-medium);
        overflow: hidden;
    }

    .progress-custom .progress-bar {
        border-radius: 10px;
        transition: width 0.6s ease;
    }

    .quick-stats {
        background: linear-gradient(135deg, var(--gray-light), var(--gray-medium));
        border-radius: 12px;
        padding: 25px;
    }

    .quick-stat-item {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .quick-stat-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray-dark);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    /* Chart specific styling */
    .chart-legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 6px;
    }

    @media (max-width: 768px) {
        .stats-number {
            font-size: 1.8rem;
        }
        
        .stats-icon {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }
        
        .chart-body {
            padding: 15px;
        }
        
        .chart-header {
            padding: 15px 20px;
        }
    }

    /* Animation for numbers */
    @keyframes countUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-number {
        animation: countUp 0.8s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<!-- Key Metrics Row -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">Total Events</p>
                    <h3 class="stats-number animate-number">{{ total_events }}</h3>
                    <small class="text-success">{{ active_events }} active</small>
                </div>
                <div class="stats-icon primary">
                    <i class="bi bi-calendar-event"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stats-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">Total Bookings</p>
                    <h3 class="stats-number animate-number">{{ total_bookings }}</h3>
                    <small class="text-warning">{{ pending_bookings }} pending</small>
                </div>
                <div class="stats-icon success">
                    <i class="bi bi-ticket-perforated"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stats-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">Total Revenue</p>
                    <h3 class="stats-number animate-number">KSh {{ total_revenue|floatformat:0 }}</h3>
                    <small class="text-success">KSh {{ revenue_30_days|floatformat:0 }} (30 days)</small>
                </div>
                <div class="stats-icon info">
                    <i class="bi bi-cash-stack"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stats-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">Avg Booking</p>
                    <h3 class="stats-number animate-number">KSh {{ avg_booking_value|floatformat:0 }}</h3>
                    <small class="text-info">{{ total_customers }} customers</small>
                </div>
                <div class="stats-icon warning">
                    <i class="bi bi-graph-up"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Revenue Trend Chart -->
    <div class="col-xl-8">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-graph-up me-2"></i>Revenue & Bookings Trend (Last 12 Months)</h5>
            </div>
            <div class="chart-body">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Booking Status Donut Chart -->
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-pie-chart me-2"></i>Booking Status Distribution</h5>
            </div>
            <div class="chart-body">
                <canvas id="statusChart" ></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Second Charts Row -->
<div class="row g-4 mb-4">
    <!-- Category Performance Bar Chart -->
    <div class="col-xl-7">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-bar-chart me-2"></i>Category Performance</h5>
            </div>
            <div class="chart-body">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Daily Bookings Area Chart -->
    <div class="col-xl-5">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-activity me-2"></i>Daily Bookings (Last 30 Days)</h5>
            </div>
            <div class="chart-body">
                <canvas id="dailyChart" ></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables Row -->
<div class="row g-4 mb-4">
    <!-- Top Events -->
    <div class="col-xl-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-star me-2"></i>Top Performing Events</h5>
            </div>
            <div class="chart-body p-0">
                <div class="table-responsive">
                    <table class="table table-dashboard mb-0">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Bookings</th>
                                <th>Revenue</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in top_events %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ event.title|truncatechars:30 }}</strong>
                                        <br><small class="text-muted">{{ event.location.name }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ event.booking_count }}</span>
                                </td>
                                <td>
                                    <strong>KSh {{ event.total_revenue|floatformat:0|default:"0" }}</strong>
                                </td>
                                <td>
                                    <span class="badge badge-status bg-{% if event.status == 'published' %}success{% else %}warning{% endif %}">
                                        {{ event.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="empty-state">
                                        <i class="bi bi-calendar-x"></i>
                                        <p class="mb-0">No events with bookings yet</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-xl-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-clock-history me-2"></i>Recent Bookings</h5>
            </div>
            <div class="chart-body">
                {% for booking in recent_bookings %}
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong>{{ booking.customer_name }}</strong>
                            <div class="text-muted small">{{ booking.event.title|truncatechars:35 }}</div>
                            <small class="text-muted">{{ booking.booked_at|timesince }} ago</small>
                        </div>
                        <div class="text-end">
                            <span class="badge badge-status bg-{% if booking.status == 'confirmed' %}success{% elif booking.status == 'pending' %}warning{% elif booking.status == 'paid' %}primary{% else %}secondary{% endif %}">
                                {{ booking.get_status_display }}
                            </span>
                            <div class="small text-muted mt-1">KSh {{ booking.total_amount|floatformat:0 }}</div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p class="mb-0">No recent bookings</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats and Alerts -->
<div class="row g-4 mb-4">
    <!-- System Alerts -->
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>System Alerts</h5>
            </div>
            <div class="chart-body">
                {% if pending_whatsapp > 0 %}
                <div class="alert alert-warning alert-custom d-flex align-items-center mb-3">
                    <i class="bi bi-whatsapp me-3 fs-4"></i>
                    <div>
                        <strong>{{ pending_whatsapp }}</strong> WhatsApp booking requests pending
                    </div>
                </div>
                {% endif %}

                {% if unresolved_inquiries > 0 %}
                <div class="alert alert-info alert-custom d-flex align-items-center mb-3">
                    <i class="bi bi-envelope me-3 fs-4"></i>
                    <div>
                        <strong>{{ unresolved_inquiries }}</strong> unresolved customer inquiries
                    </div>
                </div>
                {% endif %}

                {% if expiring_events > 0 %}
                <div class="alert alert-danger alert-custom d-flex align-items-center mb-3">
                    <i class="bi bi-calendar-x me-3 fs-4"></i>
                    <div>
                        <strong>{{ expiring_events }}</strong> events with booking deadlines expiring soon
                    </div>
                </div>
                {% endif %}

                {% if pending_whatsapp == 0 and unresolved_inquiries == 0 and expiring_events == 0 %}
                <div class="alert alert-success alert-custom d-flex align-items-center">
                    <i class="bi bi-check-circle me-3 fs-4"></i>
                    <div>
                        All systems are running smoothly!
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Payment Methods -->
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-credit-card me-2"></i>Payment Methods</h5>
            </div>
            <div class="chart-body">
                <canvas id="paymentMethodsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="col-xl-4">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-speedometer me-2"></i>Quick Stats</h5>
            </div>
            <div class="chart-body">
                <div class="quick-stats">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="quick-stat-item">
                                <h4 class="mb-0 text-primary">{{ repeat_customers }}</h4>
                                <small class="text-muted">Repeat Customers</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="quick-stat-item">
                                <h4 class="mb-0 text-warning">{{ avg_rating }}</h4>
                                <small class="text-muted">Avg Rating</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="quick-stat-item">
                                <h4 class="mb-0 text-success">{{ total_reviews }}</h4>
                                <small class="text-muted">Total Reviews</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="quick-stat-item">
                                <h4 class="mb-0 text-info">{{ revenue_7_days|floatformat:0 }}</h4>
                                <small class="text-muted">7-Day Revenue</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Popular Locations Table -->
<div class="row g-4">
    <div class="col-12">
        <div class="chart-container">
            <div class="chart-header">
                <h5><i class="bi bi-geo-alt me-2"></i>Popular Destinations</h5>
            </div>
            <div class="chart-body p-0">
                <div class="table-responsive">
                    <table class="table table-dashboard mb-0">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>County</th>
                                <th>Events</th>
                                <th>Bookings</th>
                                <th>Popularity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for location in popular_locations %}
                            <tr>
                                <td>
                                    <strong>{{ location.name }}</strong>
                                    <br><small class="text-muted">{{ location.region }}</small>
                                </td>
                                <td>{{ location.county }}</td>
                                <td>
                                    <span class="badge bg-info">{{ location.event_count }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ location.booking_count }}</span>
                                </td>
                                <td>
                                    <div class="progress progress-custom">
                                        <div class="progress-bar bg-primary" style="width: {{ location.booking_count|progress_width:10 }}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <div class="empty-state">
                                        <i class="bi bi-geo-alt"></i>
                                        <p class="mb-0">No location data available</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js Configuration
Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.color = '#6c757d';
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(13, 107, 104, 0.9)';
Chart.defaults.plugins.legend.labels.usePointStyle = true;

// Revenue and Bookings Trend Chart
const revenueCtx = document.getElementById('revenueChart').getContext('2d');
const monthlyData = {{ monthly_revenue_data|safe }};

new Chart(revenueCtx, {
    type: 'line',
    data: {
        labels: monthlyData.map(item => item.month),
        datasets: [{
            label: 'Revenue (KSh)',
            data: monthlyData.map(item => item.revenue),
            borderColor: '#0d6b68',
            backgroundColor: 'rgba(13, 107, 104, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y',
            pointBackgroundColor: '#0d6b68',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }, {
            label: 'Bookings',
            data: monthlyData.map(item => item.bookings),
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            yAxisID: 'y1',
            pointBackgroundColor: '#28a745',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            x: {
                display: true,
                grid: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Month',
                    color: '#6c757d',
                    font: {
                        weight: '600'
                    }
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Revenue (KSh)',
                    color: '#6c757d',
                    font: {
                        weight: '600'
                    }
                },
                ticks: {
                    callback: function(value) {
                        return 'KSh ' + value.toLocaleString();
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Bookings',
                    color: '#6c757d',
                    font: {
                        weight: '600'
                    }
                },
                grid: {
                    drawOnChartArea: false,
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    padding: 20,
                    font: {
                        size: 12,
                        weight: '600'
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(13, 107, 104, 0.9)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#0a5652',
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: true
            }
        }
    }
});

// Booking Status Donut Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusData = {{ booking_status_data|safe }};

new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: statusData.map(item => item.status),
        datasets: [{
            data: statusData.map(item => item.count),
            backgroundColor: [
                '#0d6b68',
                '#28a745', 
                '#ffc107',
                '#dc3545',
                '#6c757d',
                '#17a2b8'
            ],
            borderWidth: 0,
            hoverOffset: 15
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: {
                        size: 11,
                        weight: '500'
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = Math.round((context.raw / total) * 100);
                        return `${context.label}: ${context.raw} (${percentage}%)`;
                    }
                }
            }
        }
    }
});

// Category Performance Bar Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryData = {{ category_performance_data|safe }};

new Chart(categoryCtx, {
    type: 'bar',
    data: {
        labels: categoryData.map(item => item.name),
        datasets: [{
            label: 'Bookings',
            data: categoryData.map(item => item.bookings),
            backgroundColor: 'rgba(13, 107, 104, 0.8)',
            borderColor: '#0d6b68',
            borderWidth: 1,
            borderRadius: 4,
            barPercentage: 0.6
        }, {
            label: 'Revenue (KSh)',
            data: categoryData.map(item => item.revenue),
            backgroundColor: 'rgba(40, 167, 69, 0.8)',
            borderColor: '#28a745',
            borderWidth: 1,
            borderRadius: 4,
            barPercentage: 0.6,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                display: true,
                grid: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Categories',
                    color: '#6c757d',
                    font: {
                        weight: '600'
                    }
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Bookings',
                    color: '#6c757d',
                    font: {
                        weight: '600'
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Revenue (KSh)',
                    color: '#6c757d',
                    font: {
                        weight: '600'
                    }
                },
                grid: {
                    drawOnChartArea: false,
                },
                ticks: {
                    callback: function(value) {
                        return 'KSh ' + value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    padding: 20,
                    font: {
                        size: 12,
                        weight: '600'
                    }
                }
            }
        }
    }
});

// Daily Bookings Area Chart
const dailyCtx = document.getElementById('dailyChart').getContext('2d');
const dailyData = {{ daily_bookings_data|safe }};

new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: dailyData.map(item => item.day),
        datasets: [{
            label: 'Daily Bookings',
            data: dailyData.map(item => item.bookings),
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.2)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#17a2b8',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                },
                title: {
                    display: true,
                    text: 'Bookings',
                    color: '#6c757d',
                    font: {
                        weight: '600'
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Day of Month',
                    color: '#6c757d',
                    font: {
                        weight: '600'
                    }
                },
                grid: {
                    display: false
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Payment Methods Donut Chart
const paymentCtx = document.getElementById('paymentMethodsChart').getContext('2d');
const paymentData = {{ payment_methods_data|safe }};

if (paymentData && paymentData.length > 0) {
    new Chart(paymentCtx, {
        type: 'doughnut',
        data: {
            labels: paymentData.map(item => item.method),
            datasets: [{
                data: paymentData.map(item => item.count),
                backgroundColor: [
                    '#28a745',
                    '#0d6b68', 
                    '#ffc107',
                    '#dc3545',
                    '#6c757d',
                    '#17a2b8'
                ],
                borderWidth: 0,
                hoverOffset: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '55%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: {
                            size: 10,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((context.raw / total) * 100);
                            return `${context.label}: ${context.raw} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
} else {
    // Show message if no payment data
    paymentCtx.canvas.style.display = 'none';
    paymentCtx.canvas.parentNode.innerHTML = '<div class="empty-state"><i class="bi bi-credit-card"></i><p class="mb-0 mt-2">No payment data available</p></div>';
}

// Auto-refresh data every 5 minutes
setInterval(function() {
    location.reload();
}, 300000); // 5 minutes

// Animate numbers on page load
function animateNumbers() {
    const numbers = document.querySelectorAll('.stats-number');
    numbers.forEach(number => {
        const text = number.textContent;
        const hasCurrency = text.includes('KSh');
        const finalValue = parseFloat(text.replace(/[^\d.]/g, ''));
        
        if (!isNaN(finalValue) && finalValue > 0) {
            let currentValue = 0;
            const increment = finalValue / 50;
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= finalValue) {
                    currentValue = finalValue;
                    clearInterval(timer);
                }
                if (hasCurrency) {
                    number.textContent = 'KSh ' + Math.floor(currentValue).toLocaleString();
                } else {
                    number.textContent = Math.floor(currentValue).toLocaleString();
                }
            }, 30);
        }
    });
}

// Initialize animations when page loads
document.addEventListener('DOMContentLoaded', function() {
    animateNumbers();
    
    // Add hover effects to chart containers
    const chartContainers = document.querySelectorAll('.chart-container');
    chartContainers.forEach(container => {
        container.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        container.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}