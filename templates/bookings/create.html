{% extends 'base.html' %}
{% load static %}

{% block title %}Book {{ event.title }} - WildQuest Kenya{% endblock %}

{% block content %}
<!-- Hero Start -->
<div class="container-fluid pb-5 bg-primary hero-header">
    <div class="container py-5">
        <div class="row g-3 align-items-center">
            <div class="col-lg-8 text-center text-lg-start">
                <h1 class="display-4 mb-0 animated slideInLeft">Book Your Adventure</h1>
                <p class="text-light mt-2">{{ event.title }}</p>
            </div>
            <div class="col-lg-4 animated slideInRight">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-center justify-content-lg-end mb-0">
                        <li class="breadcrumb-item"><a class="text-primary" href="{% url 'index' %}">Home</a></li>
                        <li class="breadcrumb-item"><a class="text-primary" href="{% url 'events_list' %}">Events</a></li>
                        <li class="breadcrumb-item"><a class="text-primary" href="{% url 'event_detail' slug=event.slug %}">{{ event.title|truncatechars:20 }}</a></li>
                        <li class="breadcrumb-item text-secondary active" aria-current="page">Book</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>
<!-- Hero End -->

<!-- Display Messages -->
{% if messages %}
<div class="container mt-4">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Booking Form Start -->
<div class="container-fluid py-5">
    <div class="container py-5">
        <div class="row g-5">
            <!-- Booking Form -->
            <div class="col-lg-8">
                <div class="bg-light p-5 rounded">
                    <h3 class="mb-4">Booking Details</h3>
                    
                    <form method="post" id="bookingForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Personal Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">Personal Information</h5>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customer_name" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                                <div class="invalid-feedback">Please enter your full name.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customer_email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="customer_email" name="customer_email" required>
                                <div class="invalid-feedback">Please enter a valid email address.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customer_phone" class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone" required>
                                <div class="invalid-feedback">Please enter your phone number.</div>
                            </div>
                        </div>
                        
                        <!-- Booking Details -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">Booking Details</h5>
                            </div>
                            
                            {% if pricing_tiers %}
                            <div class="col-12 mb-3">
                                <label for="pricing_tier" class="form-label">Select Package</label>
                                <select class="form-select" id="pricing_tier" name="pricing_tier" onchange="updatePricing()">
                                    <option value="">Regular Package - KES {{ event.base_price|floatformat:0 }}</option>
                                    {% for tier in pricing_tiers %}
                                    <option value="{{ tier.id }}" data-price="{{ tier.price }}" data-available="{{ tier.available_spots }}">
                                        {{ tier.name }} - KES {{ tier.price|floatformat:0 }} ({{ tier.available_spots }} spots available)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            
                            <div class="col-md-6 mb-3">
                                <label for="adults_count" class="form-label">Number of Adults *</label>
                                <select class="form-select" id="adults_count" name="adults_count" required onchange="updatePricing()">
                                    <option value="">Select adults</option>
                                    {% for i in "123456789"|make_list %}
                                    <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                                    {% endfor %}
                                    <option value="10">10+</option>
                                </select>
                                <div class="invalid-feedback">Please select number of adults.</div>
                            </div>
                            
                            {% if event.child_price %}
                            <div class="col-md-6 mb-3">
                                <label for="children_count" class="form-label">Number of Children</label>
                                <select class="form-select" id="children_count" name="children_count" onchange="updatePricing()">
                                    <option value="0">0</option>
                                    {% for i in "123456789"|make_list %}
                                    <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            
                            <div class="col-12 mb-3">
                                <label for="booking_method" class="form-label">Preferred Contact Method *</label>
                                <select class="form-select" id="booking_method" name="booking_method" required>
                                    <option value="">Select contact method</option>
                                    <option value="whatsapp">WhatsApp</option>
                                    <option value="phone">Phone Call</option>
                                    <option value="email">Email</option>
                                    <option value="online">Online</option>
                                </select>
                                <div class="invalid-feedback">Please select your preferred contact method.</div>
                            </div>
                        </div>
                        
                        <!-- Participants Information -->
                        <div class="row mb-4" id="participantsSection" style="display: none;">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">Participants Information</h5>
                                <p class="text-muted small mb-3">Please provide names for all participants (required for booking confirmation)</p>
                                <div id="participantsContainer">
                                    <!-- Participants will be added dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Optional Information (Collapsible) -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">Additional Information</h5>
                                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#additionalInfo" aria-expanded="false">
                                        <i class="fas fa-plus"></i> Optional Details
                                    </button>
                                </div>
                                
                                <div class="collapse" id="additionalInfo">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="dietary_requirements" class="form-label">Dietary Requirements</label>
                                            <textarea class="form-control" id="dietary_requirements" name="dietary_requirements" rows="3" placeholder="Any special dietary needs..."></textarea>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="special_requests" class="form-label">Special Requests</label>
                                            <textarea class="form-control" id="special_requests" name="special_requests" rows="3" placeholder="Any special requests or notes..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terms and Conditions -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="terms_accepted" required>
                                    <label class="form-check-label" for="terms_accepted">
                                        I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a> and <a href="#" data-bs-toggle="modal" data-bs-target="#cancellationModal">Cancellation Policy</a> *
                                    </label>
                                    <div class="invalid-feedback">You must agree to the terms and conditions.</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-calendar-check me-2"></i>Complete Booking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Booking Summary -->
            <div class="col-lg-4">
                <div class="bg-light p-4 rounded sticky-top">
                    <h5 class="mb-4">Booking Summary</h5>
                    
                    <!-- Event Info -->
                    <div class="mb-4">
                        {% if event.images.exists %}
                            {% for image in event.images.all %}
                                {% if image.is_primary %}
                                    <img src="{{ image.image.url }}" class="img-fluid rounded mb-3" alt="{{ image.alt_text }}" style="height: 200px; width: 100%; object-fit: cover;">
                                   
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        
                        <h6>{{ event.title }}</h6>
                        <p class="text-muted mb-1">
                            <i class="fa fa-calendar me-2"></i>{{ event.start_date|date:"M d, Y" }} - {{ event.end_date|date:"M d, Y" }}
                        </p>
                        <p class="text-muted mb-1">
                            <i class="fa fa-clock me-2"></i>{{ event.duration_days }} day{{ event.duration_days|pluralize }}
                        </p>
                        <p class="text-muted mb-0">
                            <i class="fa fa-map-marker-alt me-2"></i>{{ event.location.name }}, {{ event.location.county }}
                        </p>
                    </div>
                    
                    <!-- Pricing Breakdown -->
                    <div class="mb-4" id="pricingBreakdown">
                        <h6 class="border-bottom pb-2">Pricing Breakdown</h6>
                        <div class="pricing-details">
                            <p class="text-muted">Select participants to see pricing</p>
                        </div>
                    </div>
                    
                    <!-- Available Spots -->
                    <div class="mb-4">
                        <h6>Availability</h6>
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i> {{ event.available_spots }} spots remaining
                        </div>
                        {% if event.available_spots <= 5 %}
                        <div class="alert alert-warning">
                            <i class="fa fa-exclamation-triangle"></i> Limited spots available!
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Contact Info -->
                    <div class="text-center">
                        <h6>Need Help?</h6>
                        <p class="mb-2">
                            <a href="tel:{{ contact_info.phone }}" class="text-decoration-none">
                                <i class="fa fa-phone"></i> {{ contact_info.phone }}
                            </a>
                        </p>
                        <p class="mb-2">
                            <a href="mailto:{{ contact_info.email }}" class="text-decoration-none">
                                <i class="fa fa-envelope"></i> {{ contact_info.email }}
                            </a>
                        </p>
                        {% if contact_info.whatsapp %}
                        <p class="mb-0">
                            <a href="https://wa.me/{{ contact_info.whatsapp|cut:'+' }}" class="text-decoration-none" target="_blank">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Booking Form End -->

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>1. Booking and Payment</h6>
                <p>All bookings must be confirmed with full payment or deposit as specified. Prices are subject to change without notice.</p>
                
                <h6>2. Participation Requirements</h6>
                <p>Participants must meet physical and health requirements as specified for each event. Medical conditions must be disclosed during booking.</p>
                
                <h6>3. Safety and Liability</h6>
                <p>Participants engage in activities at their own risk. WildQuest Kenya maintains appropriate insurance but participants are advised to have personal travel insurance.</p>
                
                <h6>4. Weather and Conditions</h6>
                <p>Events may be modified or cancelled due to weather conditions or unforeseen circumstances. Alternative arrangements will be provided where possible.</p>
                
                <h6>5. Conduct</h6>
                <p>Participants must follow guide instructions and maintain respectful behavior. Violation may result in removal from the event without refund.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancellation Policy Modal -->
<div class="modal fade" id="cancellationModal" tabindex="-1" aria-labelledby="cancellationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancellationModalLabel">Cancellation Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {{ event.cancellation_policy|linebreaks }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

<script>
// Event data for JavaScript
const eventData = {
    basePrice: {{ event.base_price }},
    childPrice: {{ event.child_price|default:"0" }},
    groupDiscount: {{ event.group_discount_percentage }},
    availableSpots: {{ event.available_spots }},
    pricingTiers: [
        {% for tier in pricing_tiers %}
        {
            id: {{ tier.id }},
            name: "{{ tier.name }}",
            price: {{ tier.price }},
            availableSpots: {{ tier.available_spots }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
};

function updatePricing() {
    const adultsCount = parseInt(document.getElementById('adults_count').value) || 0;
    const childrenCount = parseInt(document.getElementById('children_count').value) || 0;
    const pricingTierSelect = document.getElementById('pricing_tier');
    const selectedTier = pricingTierSelect ? pricingTierSelect.value : null;
    
    const pricingBreakdown = document.getElementById('pricingBreakdown').querySelector('.pricing-details');
    const participantsSection = document.getElementById('participantsSection');
    
    if (adultsCount === 0) {
        pricingBreakdown.innerHTML = '<p class="text-muted">Select participants to see pricing</p>';
        participantsSection.style.display = 'none';
        return;
    }
    
    // Show participants section
    participantsSection.style.display = 'block';
    
    let adultPrice, childPrice;
    let packageName = 'Regular Package';
    
    if (selectedTier) {
        const tier = eventData.pricingTiers.find(t => t.id == selectedTier);
        if (tier) {
            adultPrice = tier.price;
            packageName = tier.name;
        }
    } else {
        adultPrice = eventData.basePrice;
    }
    
    childPrice = eventData.childPrice || adultPrice;
    
    const adultTotal = adultsCount * adultPrice;
    const childTotal = childrenCount * childPrice;
    const subtotal = adultTotal + childTotal;
    
    // Calculate group discount
    const totalParticipants = adultsCount + childrenCount;
    let discount = 0;
    if (totalParticipants >= 5 && eventData.groupDiscount > 0) {
        discount = subtotal * (eventData.groupDiscount / 100);
    }
    
    const total = subtotal - discount;
    
    let html = `
        <div class="d-flex justify-content-between mb-2">
            <span>${packageName}</span>
            <span></span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span>Adults (${adultsCount})</span>
            <span>KES ${adultTotal.toLocaleString()}</span>
        </div>
    `;
    
    if (childrenCount > 0) {
        html += `
            <div class="d-flex justify-content-between mb-2">
                <span>Children (${childrenCount})</span>
                <span>KES ${childTotal.toLocaleString()}</span>
            </div>
        `;
    }
    
    html += `
        <div class="d-flex justify-content-between mb-2">
            <span>Subtotal</span>
            <span>KES ${subtotal.toLocaleString()}</span>
        </div>
    `;
    
    if (discount > 0) {
        html += `
            <div class="d-flex justify-content-between mb-2 text-success">
                <span>Group Discount (${eventData.groupDiscount}%)</span>
                <span>-KES ${discount.toLocaleString()}</span>
            </div>
        `;
    }
    
    html += `
        <hr>
        <div class="d-flex justify-content-between">
            <strong>Total</strong>
            <strong>KES ${total.toLocaleString()}</strong>
        </div>
    `;
    
    pricingBreakdown.innerHTML = html;
    updateParticipants(adultsCount, childrenCount);
}

function updateParticipants(adults, children) {
    const container = document.getElementById('participantsContainer');
    container.innerHTML = '';
    
    const totalParticipants = adults + children;
    if (totalParticipants === 0) return;
    
    for (let i = 1; i <= adults; i++) {
        container.appendChild(createParticipantFields(i, 'adult', `Adult ${i}`));
    }
    
    for (let i = 1; i <= children; i++) {
        container.appendChild(createParticipantFields(adults + i, 'child', `Child ${i}`));
    }
}

function createParticipantFields(index, type, label) {
    const div = document.createElement('div');
    div.className = 'row mb-3 participant-row';
    div.innerHTML = `
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${label}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeParticipant(this)" title="Remove participant">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
        <div class="col-md-6 mb-2">
            <input type="text" class="form-control" name="participant_names[]" placeholder="Full Name" required>
            <div class="invalid-feedback">Please enter participant's full name.</div>
        </div>
        <div class="col-md-3 mb-2">
            <input type="number" class="form-control" name="participant_ages[]" placeholder="Age" min="0" max="120">
        </div>
        <div class="col-md-3 mb-2">
            <input type="hidden" name="participant_types[]" value="${type}">
            <input type="text" class="form-control" name="participant_ids[]" placeholder="ID/Passport (Optional)">
        </div>
    `;
    return div;
}

function removeParticipant(button) {
    const participantRow = button.closest('.participant-row');
    const participantType = participantRow.querySelector('input[name="participant_types[]"]').value;
    
    // Update the count selectors
    if (participantType === 'adult') {
        const adultsSelect = document.getElementById('adults_count');
        const currentCount = parseInt(adultsSelect.value);
        if (currentCount > 1) {
            adultsSelect.value = currentCount - 1;
        }
    } else {
        const childrenSelect = document.getElementById('children_count');
        const currentCount = parseInt(childrenSelect.value);
        if (currentCount > 0) {
            childrenSelect.value = currentCount - 1;
        }
    }
    
    participantRow.remove();
    updatePricing();
}

// Form validation and submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bookingForm');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Custom validation
        let isValid = true;
        
        // Clear previous validation
        form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        
        // Check required fields
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim() && field.type !== 'checkbox') {
                field.classList.add('is-invalid');
                isValid = false;
            } else if (field.type === 'checkbox' && !field.checked) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            }
        });
        
        // Validate participants
        const adultsCount = parseInt(document.getElementById('adults_count').value) || 0;
        const childrenCount = parseInt(document.getElementById('children_count').value) || 0;
        const totalParticipants = adultsCount + childrenCount;
        
        if (totalParticipants === 0) {
            document.getElementById('adults_count').classList.add('is-invalid');
            isValid = false;
        }
        
        if (totalParticipants > eventData.availableSpots) {
            alert(`Sorry, only ${eventData.availableSpots} spots are available.`);
            isValid = false;
        }
        
        // Check participant names
        const participantNames = document.querySelectorAll('input[name="participant_names[]"]');
        participantNames.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                isValid = false;
            } else {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
            }
        });
        
        if (isValid) {
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            submitBtn.disabled = true;
            
            // Submit form
            form.submit();
        } else {
            // Scroll to first error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });
    
    // Real-time email validation
    document.getElementById('customer_email').addEventListener('blur', function() {
        const email = this.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email && !emailRegex.test(email)) {
            this.classList.add('is-invalid');
        } else if (email) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
});
</script>

{% endblock %}